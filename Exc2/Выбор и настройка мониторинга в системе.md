# Мониторинг

## Мотивация к внедрению мониторинга

Внедрение системы мониторинга позволит оперативно отслеживать состояние всех компонентов системы "Александрит", выявлять узкие места и предотвращать сбои. Это особенно важно в условиях высокой зависимости от внешних сервисов (S3-хранилище, RabbitMQ, базы данных), где сбои могут привести к остановке критических бизнес-процессов.

## Что нужно измерять:

1. Доступность и производительность ключевых сервисов: MES, CRM, RabbitMQ, S3-хранилище.
2. Очереди сообщений в RabbitMQ (длина очередей, скорость обработки, ошибки).
3. Время отклика API и производительность интерфейсов.
4. Статусы заказов и их переходы между системами.
5. Ошибки и сбои в интеграциях.
6. Использование ресурсов (CPU, RAM, Disk, Network).

## Как это делать:

1. Использовать Prometheus и Grafana для сбора и визуализации метрик.
2. Настроить алертинг для критических событий (например, превышение допустимого времени отклика, недоступность хранилища).
3. Внедрить централизованное логирование с помощью ELK-стека (Elasticsearch, Logstash, Kibana) для анализа логов и поиска причин сбоев.
4. Разработать дешборды для мониторинга состояния системы в реальном времени.

## Обоснование для бизнеса:

1. Снижение рисков простоев и задержек в обработке заказов.
2. Быстрая диагностика и устранение проблем.
3. Повышение удовлетворённости клиентов за счёт более стабильной работы системы.
4. Прогнозирование нагрузки и планирование масштабирования.

## Выбор подхода к мониторингу

Для мониторинга различных частей системы предлагается использовать комбинацию подходов:

1. RED (Rate, Errors, Duration) — для API и взаимодействия с внешними системами (RabbitMQ, S3-хранилище). Это позволит контролировать частоту запросов, количество ошибок и время обработки.
2. Четыре золотых сигнала (Latency, Traffic, Errors, Saturation) — для мониторинга производительности серверов, баз данных и очередей RabbitMQ. Это поможет выявить узкие места и определить моменты, когда система перегружена.
3. USE (Utilization, Saturation, Errors) — для мониторинга инфраструктурных ресурсов (CPU, RAM, Disk, Network). Это обеспечит контроль над использованием ресурсов и поможет избежать проблем с производительностью.

## Метрики и их описание для мониторинга системы "Александрит"

1. Очереди RabbitMQ

- Number of dead-letter-exchange letters in RabbitMQ

Зачем нужна эта метрика: Показывает количество сообщений, которые не удалось обработать и которые были отправлены в очередь Dead Letter. Это помогает выявлять проблемы с обработкой сообщений и задержки.

Ярлыки:

Имя очереди (queue)

Приложение-отправитель (source)

Тип сообщения (message_type)

- Number of message in flight in RabbitMQ

Зачем нужна эта метрика: Отслеживает количество сообщений, которые находятся в процессе обработки. Высокое значение может указывать на узкие места в обработке.

Ярлыки: Имя очереди (queue), Приложение-получатель (consumer)

2. API-интерфейсы

- Number of requests (RPS) for internet shop API

Зачем нужна эта метрика: Показывает нагрузку на интернет-магазин. Позволяет понимать, когда API испытывает пиковую нагрузку и требует масштабирования.

Ярлыки: Тип запроса (request_type), Статус ответа (response_status)

- Number of requests (RPS) for CRM API

Зачем нужна эта метрика: Позволяет следить за загрузкой CRM и вовремя выявлять проблемы производительности.

Ярлыки: Тип запроса (request_type), Статус ответа (response_status)

- Response time (latency) for shop API

Зачем нужна эта метрика: Отслеживание времени отклика помогает выявлять задержки в работе интернет-магазина.

Ярлыки: Тип запроса (request_type), Регион (region)

- Response time (latency) for CRM API

Зачем нужна эта метрика: Позволяет мониторить производительность CRM и своевременно реагировать на проблемы.

Ярлыки: Тип запроса (request_type),Регион (region)

- Response time (latency) for MES API

Зачем нужна эта метрика: Важно отслеживать скорость обработки заказов в MES, чтобы улучшить пользовательский опыт.

Ярлыки: Тип запроса (request_type), Регион (region)

3. Инфраструктурные метрики

- CPU % for MES API

Зачем нужна эта метрика: Отслеживание использования процессора MES помогает избежать перегрузок и своевременно масштабировать ресурсы.

Ярлыки: Инстанс (instance), Регион (region)

- Memory Utilisation for MES API

Зачем нужна эта метрика: Контроль использования памяти позволяет избежать утечек памяти и падения производительности.

Ярлыки: Инстанс (instance), Регион (region)

- Number of connections for MES db instance

Зачем нужна эта метрика: Позволяет следить за количеством активных подключений к базе данных MES. Это важно для оптимизации работы базы и предотвращения её перегрузки.

Ярлыки: Имя базы данных (db_name),Регион (region)

- Size of S3 storage

Зачем нужна эта метрика: Позволяет следить за размером хранилища 3D-файлов и планировать его расширение.

Ярлыки: Бакет (bucket), Регион (region)

4. Ошибки и сбои

- Number of HTTP 500 for MES API

Зачем нужна эта метрика: Количество ошибок 500 показывает, сколько запросов заканчивается критическими ошибками. Это помогает быстро реагировать на проблемы.

Ярлыки: Тип запроса (request_type), Регион (region)

- Number of HTTP 500 for shop API

Зачем нужна эта метрика: Позволяет отслеживать критические ошибки интернет-магазина и их причину.

Ярлыки: Тип запроса (request_type), Регион (region)

5. Дополнительные метрики

- Number of simultanious sessions for MES API

Зачем нужна эта метрика: Показывает количество одновременных активных сессий. Это важно для понимания нагрузки в реальном времени.

Ярлыки: Инстанс (instance), Тип пользователя (user_type)

- Kb transferred (received) for MES API

Зачем нужна эта метрика: Позволяет отслеживать объём входящего трафика и прогнозировать потребность в пропускной способности.

Ярлыки: Инстанс (instance), Тип запроса (request_type)

## План действий

1. Создание инфраструктуры мониторинга:

- Развернуть time-series базу данных (например, Prometheus) для хранения метрик.
- Настроить Grafana для визуализации и создания дашбордов.

2. Настройка сбора метрик:

- Внедрить агенты сбора метрик в интернет-магазин, CRM и MES.
- Подключить RabbitMQ к системе мониторинга для отслеживания состояния очередей.

3. Настройка алертов и уведомлений:

- Определить пороговые значения для критичных метрик.
- Настроить алерты в Grafana для уведомления о сбоях и отклонениях.

4. Обучение команды:

- Провести обучение команды по использованию системы мониторинга и интерпретации метрик.

5. Пилотное внедрение:

- Запустить мониторинг на тестовом окружении.
- Проверить корректность работы системы и качество собираемых данных.

6. Полное внедрение:

- Распространить мониторинг на продуктивную среду.
- Настроить регулярные отчёты для анализа производительности и ошибок.

7. Оптимизация системы:

- На основе полученных данных выявить узкие места и оптимизировать систему.
- Внедрить практики профилактического обслуживания на основе метрик.

8. Обратная связь:

- Регулярно собирать обратную связь от команды о полезности мониторинга и вносить улучшения.

# Дополнительное задание

Для системы "Александрит" при мониторинге различных метрик следует установить пороговые значения насыщенности, которые помогут своевременно реагировать на возможные проблемы и обеспечат стабильность работы. Давайте рассмотрим, какие показатели насыщенности могут быть ключевыми для системы и какие действия должны быть предприняты при их превышении.

1. Метрики очередей RabbitMQ

1.1 Number of dead-letter-exchange letters in RabbitMQ

Пороговое значение: > 100 сообщений
Почему такое значение: Сообщения, попадающие в dead-letter-очередь, обычно свидетельствуют о проблемах с обработкой. Постоянное увеличение их числа может указывать на проблемы с логикой обработки сообщений или нагрузкой на систему.

Меры при превышении порога:

Тикет в поддержку: Если количество сообщений в dead-letter-очереди превышает порог, это может потребовать вмешательства разработчиков для анализа и исправления проблемы.

Оповещение в систему мониторинга: Настроить алерт, чтобы операторы получали уведомление о высоком уровне сообщений.
Реобработка сообщений: Если проблема носит временный характер, следует рассмотреть возможность вручную переместить сообщения обратно в основную очередь для повторной обработки.

1.2 Number of message in flight in RabbitMQ

Пороговое значение: > 1000 сообщений
Почему такое значение: Высокое количество сообщений, находящихся в процессе обработки, может свидетельствовать о том, что система не успевает обрабатывать все поступающие запросы, что может привести к задержкам и сбоям.

Меры при превышении порога:
Масштабирование: Если сообщения не успевают обрабатываться, нужно добавить дополнительные инстансы для распределения нагрузки.
Оповещение: Уведомление разработчиков и команду операционного мониторинга о повышенной нагрузке.
Проверка производительности потребителей: Если нагрузка остается высокой, провести анализ производительности потребителей и оптимизировать их работу.

2. Метрики API-интерфейсов

2.1 Number of requests (RPS) for internet shop API

Пороговое значение: > 1000 запросов в секунду
Почему такое значение: Высокий уровень запросов может привести к перегрузке API и, как следствие, ухудшению производительности.

Меры при превышении порога:
Автоматическое масштабирование: Увеличение числа серверов или контейнеров для масштабирования API-интерфейса.
Оповещение: Уведомление DevOps команды через алерт о высоком уровне запросов.
Оптимизация кода: Проверить и оптимизировать код API для уменьшения времени обработки запросов.

2.2 Response time (latency) for shop API

Пороговое значение: > 2 секунд на запрос
Почему такое значение: Если время отклика API превышает 2 секунды, это может существенно ухудшить пользовательский опыт и привести к отказам пользователей от взаимодействия с сайтом.

Меры при превышении порога:
Анализ причин задержек: Провести анализ бэкенда для выявления причин задержек, таких как нагрузка на сервер, ошибки в коде, проблемы с базой данных.
Масштабирование: Если проблема связана с нагрузкой, выполнить горизонтальное масштабирование.

2.3 Number of HTTP 500 for MES API

Пороговое значение: > 5 ошибок HTTP 500 в минуту
Почему такое значение: Ошибки HTTP 500 — это критические ошибки сервера, которые указывают на проблемы с API. Их большое количество может указывать на системные сбои или проблемы с инфраструктурой.

Меры при превышении порога:
Тикет в поддержку: Немедленно завести тикет в команду разработки для диагностики и устранения причины ошибок.
Оповещение: Уведомить операционную команду и техническую поддержку для быстрого реагирования на ошибки.
Детальный анализ логов: Проверить логи, чтобы понять, какие запросы приводят к ошибкам и что является их основной причиной.

3. Инфраструктурные метрики

3.1 CPU % for MES API

Пороговое значение: > 85%
Почему такое значение: Если использование ЦПУ превышает 85%, это может привести к снижению производительности и увеличению задержек.
Меры при превышении порога:
Масштабирование: Добавить дополнительные инстансы для разгрузки серверов.
Оповещение: Настроить уведомления для DevOps команды о высоком уровне загрузки процессора.
Анализ процессов: Проверить текущие процессы и их использование ЦПУ, чтобы оптимизировать код и снизить нагрузку.

3.2 Memory Utilisation for MES API

Пороговое значение: > 90%
Почему такое значение: Высокое использование памяти может привести к утечкам, зависаниям системы и даже её краху.
Меры при превышении порога:
Мониторинг и анализ: Проверить текущие процессы, выявить утечки памяти и оптимизировать их.
Масштабирование: Добавить новые инстансы для распределения нагрузки на память.
Тикет в поддержку: Если проблема связана с программным обеспечением, нужно обратиться в техническую поддержку.

3.3 Number of connections for MES db instance

Пороговое значение: > 80% от максимального числа соединений
Почему такое значение: Перегрузка базы данных из-за превышения максимального числа соединений может привести к сбоям и замедлению работы системы.
Меры при превышении порога:
Масштабирование базы данных: Увеличить количество доступных подключений или разделить нагрузку на несколько баз данных.
Оповещение: Настроить уведомления для администраторов базы данных.
Оптимизация запросов: Проанализировать и оптимизировать запросы для уменьшения нагрузки на базу данных.

4. Ошибки и сбои

4.1 Number of HTTP 500 for shop API

Пороговое значение: > 3 ошибки в минуту
Почему такое значение: Высокий уровень ошибок 500 может свидетельствовать о серьезных сбоях в работе интернет-магазина.
Меры при превышении порога:
Тикет в поддержку: Нужно немедленно завести тикет для диагностики.
Оповещение через «звонилку»: Оперативное уведомление команды о критической ошибке через систему оповещений.
Анализ логов: Тщательно проверить логи для поиска причин возникновения ошибок.

5. Дополнительные метрики

5.1 Number of simultaneous sessions for MES API

Пороговое значение: > 1000 активных сессий
Почему такое значение: Высокое количество одновременных сессий может перегрузить сервер и привести к сбоям в обработке.
Меры при превышении порога:
Масштабирование: Увеличить количество серверов для распределения нагрузки.
Оповещение: Уведомление операционной команды для оперативного реагирования.

5.2 Kb transferred (received) for MES API

Пороговое значение: > 10 ГБ в час
Почему такое значение: При превышении этого порога может возникнуть необходимость в увеличении пропускной способности сети или обновлении инфраструктуры для поддержания работы системы.
Меры при превышении порога:
Оптимизация трафика: Анализировать, какие данные передаются, и искать способы их сжатия или улучшения методов передачи.
Масштабирование сети: Добавить дополнительную пропускную способность.

Заключение

При превышении пороговых значений для каждой метрики важно принять соответствующие меры, такие как масштабирование, оптимизация или привлечение технической поддержки. Непрерывный мониторинг с настройкой алертов и автоматического реагирования поможет обеспечить стабильную работу системы и своевременно выявлять проблемы до того, как они повлияют на пользователей.
