# Задание 4. Логирование

## Планирование логирования для упрощения разбора проблем и снижения нагрузки на поддержку

Для того чтобы улучшить процессы выявления и устранения проблем в сервисах, требуется системное решение, основанное на эффективном логировании. Логи должны обеспечивать нужную информацию для быстрого анализа и устранения ошибок, а также снижения времени, которое специалисты поддержки тратят на разбор инцидентов.

### Анализ системы компании и C4-диаграммы

Предполагается, что компания использует распределенную архитектуру с несколькими компонентами, такими как:

- Frontend (Интерфейс пользователя)
- Backend (API сервисы, серверная логика)
- Система управления заказами (сервисы для обработки заказов)
- Система оплаты (платежные шлюзы)
- Система доставки (службы доставки)
- Базы данных и хранилища данных
- Система мониторинга (например, Prometheus, Grafana)
- Система поддержки и тикетирования (например, Jira, ServiceNow)
- Система должна обеспечивать сбор логов с этих различных компонентов, чтобы создавать полную картину происходящих ошибок и событий, а также позволить разработчикам и службе поддержки быстро реагировать на инциденты.

### Какие логи нужно собирать?

Основные логируемые события должны быть связаны с ключевыми процессами, такими как создание заказа, изменение статуса, успешные и неудачные транзакции, ошибки и сбои. Логи должны быть структурированными и содержать информацию, которая позволит точно понять, что произошло, на каком этапе и почему.

1. Логи по статусу заказа:

- Событие: Изменение статуса заказа (например, подтверждение, отмена, доставка)
- Необходимые поля в логе:
- Время изменения статуса
- Идентификатор заказа
- Идентификатор покупателя
- Новый статус заказа
- Примечание или причина изменения статуса (например, причина отмены или отклонения)

2. Логи по процессу оплаты:

- Событие: Успешное или неуспешное выполнение транзакции
- Необходимые поля в логе:
- Время выполнения транзакции
- Идентификатор заказа
- Идентификатор пользователя
- Статус транзакции (успех/неудача)
- Информация о платёжном шлюзе
- Ошибки при обработке платежа

3. Логи по процессу доставки:

Событие: Отправка заказа, доставка, возврат

Необходимые поля в логе:

- Время отправки/доставки
- Идентификатор заказа
- Идентификатор покупателя
- Служба доставки
- Статус доставки (доставлено, в пути, неудачная попытка и т. д.)

4. Логи ошибок и сбоев в сервисах:

Событие: Ошибка или сбой в процессе выполнения запроса

Необходимые поля в логе:

- Время ошибки
- Идентификатор запроса
- Трейс запроса (или ссылка на трассировку)
- Статус ошибки (например, 500, 404)
- Описание ошибки (текст ошибки, стек вызовов)
- Информация о сервисе, в котором произошел сбой (например, база данных, API и т. д.)

5. Логи о пользователях:

Событие: Аутентификация и авторизация пользователей

Необходимые поля в логе:

- Время авторизации
- Идентификатор пользователя
- Успешная или неудачная попытка входа
- IP-адрес пользователя
- Примечания (например, причина неудачной попытки входа)
- Уровни логирования

Для упрощения поиска и анализа проблем важно правильно настроить уровни логирования. Рассмотрим возможные уровни и их применение:

INFO:

Для отслеживания обычных, успешных операций, которые являются частью нормальной работы системы.

Примеры: Изменение статуса заказа, успешная транзакция, отправка заказа, успешная аутентификация.

Пример лога:

yaml

INFO | 2025-01-06 10:15:00 | Order ID: 12345 | Status changed to 'Shipped' | Customer ID: 7890

DEBUG:

Для более подробной информации, предназначенной для разработки и диагностики. Эти логи могут включать детали о параметрах запросов, значениях переменных и других элементах, которые могут помочь при отладке системы.

Примеры: Подробности запроса пользователя, параметры API-запроса, дополнительные диагностические данные.

Пример лога:

DEBUG | 2025-01-06 10:15:00 | Order ID: 12345 | API request parameters: {"amount": 100, "payment_method": "credit_card"}

ERROR:

Для ошибок, которые требуют немедленного внимания. Это может быть связано с неудачной транзакцией, сбоями в процессе заказа, критическими ошибками в сервисах.

Примеры: Ошибка в процессе оплаты, сбой в системе доставки, критические сбои серверов.

Пример лога:

ERROR | 2025-01-06 10:17:00 | Order ID: 12345 | Payment failed | Error code: 500 | Payment gateway unavailable

WARN:

Для предупреждений, которые не являются критическими, но могут свидетельствовать о потенциальных проблемах в будущем.

Примеры: Некорректные данные, незначительные проблемы с подключением или зависания системы.

Пример лога:

WARN | 2025-01-06 10:20:00 | Order ID: 12345 | Payment gateway delayed | Customer ID: 7890

CRITICAL:

Для серьезных сбоев в системе, которые могут повлиять на работу сервиса. Этот уровень используется крайне редко и должен сопровождаться немедленным вмешательством специалистов.

Примеры: Полный отказ системы, утечка данных, критические сбои.

Пример лога:

CRITICAL | 2025-01-06 10:25:00 | Order ID: 12345 | System crash | Service: Order Processing

### Сбор логов

Для эффективного логирования и мониторинга ошибок важно правильно организовать сбор логов с различных систем. Ниже приведены основные системы, из которых потребуется сбор логов:

Система управления заказами:

- Логи изменения статусов заказов.
- Логи ошибок при обработке заказов.
- Платежная система:
- Логи транзакций, включая успешные и неудачные платежи.
- Логи ошибок при взаимодействии с платёжными шлюзами.
- Система доставки:
- Логи изменения статуса доставки.
- Логи ошибок в процессе доставки.

Сервисы фронтенда:

- Логи пользовательских действий.
- Логи ошибок на уровне клиента.

Сервисы бэкенда:

- Логи успешных и неудачных API-запросов.
- Логи системных ошибок.

Системы мониторинга и инфраструктуры:

- Логи, связанные с производительностью и доступностью сервисов.
- Логи аномальных событий и нагрузки.

Система поддержки:

- Логи тикетов и обращений пользователей.
- Логи ошибок и запросов в службу поддержки.

Заключение

Логирование — это ключевой элемент для эффективного отслеживания состояния системы и быстрого выявления причин проблем. Правильная настройка уровней логирования и сбор логов с разных систем позволит оперативно реагировать на инциденты, уменьшить время на их анализ и разбор, а также снизить нагрузку на службу поддержки.

## Мотивация

Логирование — это не просто сбор данных, но и важный инструмент для улучшения производительности и надежности системы, а также для повышения качества обслуживания клиентов. Оно позволяет компании систематически отслеживать и анализировать процессы, выявлять проблемы на ранних этапах и принимать своевременные меры для их устранения. Логирование и трейсинг обеспечивают прозрачность всех операций и являются основой для быстрого реагирования на инциденты, диагностики проблем и оптимизации бизнес-процессов.

Что даст внедрение логирования?

Быстрое выявление и устранение проблем: При возникновении ошибок или нестандартных ситуаций специалисты смогут быстро понять, что произошло, и начать исправление, не теряя времени на поиски причин. Это значительно ускоряет процесс устранения неисправностей и повышает стабильность системы.
Прозрачность процессов: Логирование позволяет отслеживать каждое изменение в системе, будь то изменение статуса заказа, ошибка в платежной системе или отказ в доставке. Это дает полное представление о работе системы, а также помогает в дальнейшем анализе.

Повышение качества обслуживания клиентов: С помощью логирования компания может минимизировать простои, улучшить скорость реакции на запросы клиентов и предсказать возможные проблемы до того, как они станут критическими. Это, в свою очередь, повышает удовлетворенность клиентов.
Улучшение производительности и оптимизация процессов: Логирование помогает идентифицировать узкие места в системе, например, медленные запросы к базе данных или перегрузки на конкретных сервисах. Эти данные можно использовать для оптимизации работы системы.

### Технические и бизнес-метрики, на которые может повлиять внедрение логирования

1. Время реагирования на инциденты: Логирование позволяет быстро находить причины инцидентов и получать точную информацию о сбоях. С этим знанием поддержка сможет сократить время на диагностику и ускорить процесс устранения проблем.
2. Производительность системы: Введение логирования помогает отслеживать метрики нагрузки и выявлять узкие места. С помощью логов можно определить, какие части системы нуждаются в оптимизации для повышения общей производительности.
3. Уровень удовлетворенности клиентов: Логирование ошибок и инцидентов в реальном времени позволяет быстрее реагировать на запросы клиентов, исправлять ошибки и минимизировать их последствия. Это напрямую влияет на уровень удовлетворенности пользователей и улучшает их опыт взаимодействия с сервисом.
4. Частота ошибок и отказов: Логирование позволяет отслеживать количество и типы ошибок, выявлять повторяющиеся сбои и улучшать процессы для предотвращения их возникновения в будущем. Меньше ошибок — выше надежность системы и меньшая нагрузка на службу поддержки.
5. Скорость обработки заказов: Логирование помогает отслеживать все этапы выполнения заказов, включая подтверждение, оплату и доставку. Это помогает ускорить процессы, выявлять и устранять задержки, что в свою очередь улучшает операционную эффективность и сокращает время обработки заказов.

### Приоритетные системы для логирования и трейсинга

Так как логирование и трейсинг всех систем невозможно внедрить одновременно, нужно определить приоритетные компоненты, в которых логирование даст наибольшую ценность.

1. Система управления заказами (Order Management System)
   Логирование статусов заказов, их изменений и ошибок в этой системе должно быть в первую очередь, поскольку заказ — это ключевая сущность во всей бизнес-логике. Быстрая диагностика проблем с заказами позволит устранить ошибки на самых ранних этапах и сократить число ошибок, связанных с заказами. Например, если заказ не был правильно обработан, а клиент сообщает об этом, то можно быстро найти источник ошибки и исправить его, что повысит удовлетворенность клиентов.
2. Платежная система (Payment Gateway)
   Платежи являются критичной частью процесса, и любые сбои в этом процессе могут привести к потере клиентов и доходов. Логирование транзакций и ошибок при обработке платежей позволит оперативно отслеживать и устранять ошибки, не доводя их до клиентов. Например, если клиент не может оплатить заказ, это сразу фиксируется в логах, и специалисты могут оперативно вмешаться.
3. Система доставки (Delivery System)
   Ошибки в процессе доставки, такие как задержки, утеряные заказы или неправильные адреса, могут серьезно повлиять на клиентский опыт. Логирование всех изменений статусов доставки и возникающих проблем поможет быстрее выявить проблемы и устранить их до того, как они станут критическими. Например, если доставка не была выполнена в срок, это фиксируется в логах, и можно быстро решить проблему с курьером или логистической службой.
4. Backend API-сервисы
   Логирование работы бэкенд-сервисов, которые обрабатывают запросы пользователей, позволит быстрее находить проблемы, такие как ошибки выполнения API-запросов, отказ в сервисах, неполадки в интеграции с другими системами. Эти логи критичны для мониторинга и устранения неполадок на серверной стороне.
5. Система мониторинга и аналитики
   Хотя мониторинг и сбор метрик — это отдельный процесс, он имеет смысл только в контексте логирования. Настройка мониторинга с правильным логированием поможет в случае возникновения аварийных ситуаций быстрее найти причину, будь то высокое время отклика сервера, превышение лимитов или отказ критичного компонента системы.

Заключение

Внедрение логирования и трейсинга имеет значительное значение для быстрого реагирования на инциденты, диагностики проблем и улучшения взаимодействия с клиентами. С помощью логирования можно сократить время на решение проблем, повысить производительность и надежность системы, а также улучшить клиентский опыт. Логирование в приоритетных системах, таких как система управления заказами, платежная система, система доставки и backend API-сервисы, даст наибольшую отдачу в первую очередь.

## Предлагаемое решение

Для реализации логирования в системе, необходимо внедрить ряд технологий и компонентов, обеспечивающих сбор, хранение и анализ логов. Логирование должно быть масштабируемым и гибким, а также соответствовать требованиям безопасности и конфиденциальности.

Технологии для реализации логирования:

1. Платформа для централизованного логирования:

ELK Stack (Elasticsearch, Logstash, Kibana) — для сбора, хранения, обработки и визуализации логов.
Elasticsearch — для хранения логов и быстрого поиска по ним.
Logstash — для сбора и обработки логов, их отправки в Elasticsearch.
Kibana — для визуализации данных, создания дашбордов и отчетов.

2. Агенты логирования:

Filebeat — легковесный агент, который будет собирать и отправлять логи с серверов на Logstash или напрямую в Elasticsearch.
Fluentd — может быть использован как альтернатива Filebeat для сбора логов с более сложной логикой маршрутизации и обработки.

3. Мониторинг и алертинг:

Prometheus + Grafana — для мониторинга производительности системы и создания алертов. В связке с логами это даст возможность автоматически отслеживать проблемы и генерировать алерты, если какие-то события в логах превышают заданные пороги.

4. Инструменты для трейсинга:

OpenTelemetry — для сбора и трассировки данных о выполнении запросов в системе и взаимодействии между компонентами. Это поможет связать логи с конкретными запросами и отслеживать поведение системы в контексте бизнес-логики.

5. Интерфейсы для доступа к логам:

Kibana или Grafana для отображения логов в виде дашбордов, доступных только авторизованным пользователям, которые имеют соответствующие права доступа.

### Компоненты, которые нужно внедрить или доработать:

1. Системы логирования (сбор логов):

Все микросервисы и системы, такие как система управления заказами, платежная система, система доставки и API-сервисы, должны быть оснащены встроенными средствами логирования с использованием стандартов (например, Logback или SLF4J для Java или Winston для Node.js).
Каждый микросервис будет отправлять логи в централизованную систему с помощью Filebeat или Fluentd.

2. Централизованное хранилище и обработка данных (ELK Stack):

Elasticsearch будет использоваться для хранения и быстрого поиска по логам. Вся информация будет агрегироваться в одном индексе, что обеспечит единый доступ ко всем данным.
Logstash будет отвечать за фильтрацию, преобразование и отправку данных в Elasticsearch, а также за обработку всех нестандартных данных перед их индексированием.

3. Интерфейсы визуализации и мониторинга:

Kibana или Grafana будет использоваться для визуализации логов и создания дашбордов. Пользователи с правами доступа смогут отслеживать статусы системы, выявлять аномалии и формировать отчеты по ключевым меткам.

4. Трассировка данных (OpenTelemetry):

Трассировка будет интегрирована на уровне микросервисов и API, чтобы собирать данные о запросах и операциях, происходящих между компонентами. Это позволит не только отслеживать действия пользователей, но и выявлять проблемные точки в взаимодействии систем.

### Политика безопасности работы с логами:

1. Доступ к логам:

Логи будут доступны только тем пользователям и группам, которым это необходимо для выполнения своей работы. Например, для команд поддержки, DevOps и разработчиков.
Доступ к логам будет разделен по ролям, с использованием системы RBAC (Role-Based Access Control) в Kibana и Elasticsearch, чтобы ограничить доступ к чувствительным данным только авторизованным сотрудникам.
Для защиты логов от несанкционированного доступа будет использоваться шифрование данных как в транзите (например, TLS), так и в покое (например, с помощью алгоритмов шифрования на уровне хранилища).

2. Чувствительные данные:

Логирование чувствительных данных, таких как пароли, номера кредитных карт или персональная информация, будет запрещено или заменено на анонимизированные значения (например, через хеширование).
Если хранение определенных типов чувствительных данных необходимо для функциональности, такие данные будут записываться в логи с обязательным шифрованием.

3. Журналирование действий пользователей:

Все действия, связанные с доступом к логам (например, просмотр, изменение или удаление логов), должны быть зафиксированы и доступными для аудита.

### Политика хранения логов:

1. Структура хранения логов:

Логи будут храниться в индексах Elasticsearch, причем для каждой системы (например, система управления заказами, платежная система и т. д.) будет создаваться отдельный индекс.
Каждая система будет иметь свой собственный индекс для упрощения поиска и уменьшения нагрузки на систему.

2. Продолжительность хранения:

Логи будут храниться на протяжении 30-90 дней в зависимости от политики компании и требований регуляторов.
Логи, которые являются критичными для диагностики и обеспечения безопасности, могут храниться дольше, в то время как менее важные логи будут удаляться или архивироваться через заданные интервалы.

3. Размер и ротация логов:

Логи будут храниться с размером индекса, ограниченным до 1 ТБ. Для обеспечения производительности и избегания проблем с излишним объемом данных, будут настроены механизмы ротации логов (например, создание новых индексов каждый месяц или по достижению определенного размера).
После достижения предельного размера или срока хранения, логи будут автоматически архивироваться или удаляться, чтобы освободить место.

### Обновленная C4-диаграмма с новыми компонентами и связями:

Микросервисы (система управления заказами, платежная система, доставка и API-сервисы): эти компоненты теперь включают встроенные агенты логирования (например, Filebeat или Fluentd).

Централизованный сервер логов (ELK Stack): представляет собой единое хранилище, включая Elasticsearch, Logstash, и Kibana для обработки, хранения и визуализации логов.

Системы мониторинга и трейсинга (Prometheus + Grafana, OpenTelemetry): теперь они интегрированы с системой логирования для мониторинга метрик и автоматического создания алертов на основе данных логов.

Это решение обеспечит эффективное, безопасное и прозрачное управление логами для всей системы.

## Дополнительное задание

Таблица с критериями для выбора технологии для работы с логами:


| **Критерий**                           | **ELK Stack**                                                                                                       | **OpenSearch**                                                                                                 | **Splunk**                                                                | **Что-то ещё**                                                   |
| ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------- | ------------------------------------------------------------------------ |
| **Лицензия**                           | Elastic License                                                                                                     | Apache License, Version 2.0                                                                                    | Проприетарная                                                | Проприетарная или Open Source                            |
| **Масштабируемость**           | Высокая (но требует настройки)                                                             | Высокая, как у Elasticsearch                                                                        | Отличная, масштабируемая по всем меткам | Зависит от реализации                                 |
| **Производительность**       | Хорошая при оптимизации и настройке                                                  | Похожая на Elasticsearch, также требует настройки                                | Отличная (но более ресурсоемкая)               | Зависит от системы                                       |
| **Цена**                                   | Бесплатно с ограничениями, платная версия доступна                      | Бесплатно, с возможностью коммерческой поддержки                    | Высокая стоимость лицензий                        | Может быть дешевле, зависит от продукта |
| **Управление и поддержка** | Открытая документация, активное сообщество, платная поддержка | Хорошая поддержка через сообщество, коммерческая поддержка | Прекрасная поддержка, но дорога                | Зависит от продукта                                     |

### Обоснование выбора

Лицензия:

ELK Stack: Имеет коммерческую лицензию (Elastic License), но предоставляет бесплатную версию с ограниченными функциями.
OpenSearch: Применяется Apache License 2.0, что делает его более гибким и свободным для использования в коммерческих целях.
Splunk: Проприетарная лицензия, что делает его более дорогим в плане использования, но предоставляет уникальные и продвинутые возможности.
Что-то ещё: Могут быть использованы различные решения с открытым исходным кодом или с проприетарными лицензиями, что зависит от конкретной задачи.

Масштабируемость:

ELK Stack: Высокая масштабируемость, особенно с Elasticsearch, но требует внимательной настройки и мониторинга. Это может быть проблемой для очень больших объемов данных.
OpenSearch: Также имеет высокую масштабируемость, так как основан на Elasticsearch, но с расширениями и улучшениями для повышения производительности и масштабируемости.
Splunk: Отличная масштабируемость, но требует значительных ресурсов и часто дорогая в эксплуатации.
Что-то ещё: Масштабируемость зависит от выбранной технологии. Например, Prometheus с Grafana — хорош для метрик, но не оптимален для логов.

Производительность:

ELK Stack: Хорошая производительность при правильной настройке, но может быть ограничена производственными нагрузками на Elasticsearch при высокой интенсивности.
OpenSearch: Показатели производительности аналогичны Elasticsearch, так как это форк, но улучшения могут зависеть от специфических настройок.
Splunk: Отличная производительность, но высокая нагрузка на ресурсы, что делает систему более дорогой и требующей дополнительных инвестиций в инфраструктуру.
Что-то ещё: Производительность зависит от выбранной технологии, как, например, в случае с Fluentd, который может быть хорош для небольших систем, но может не подойти для больших объемов.

Цена:

ELK Stack: Бесплатное решение с открытым исходным кодом, но некоторые функции доступны только в платной версии.
OpenSearch: Бесплатно с полным набором функций, что делает его привлекательным для малого и среднего бизнеса.
Splunk: Высокая стоимость лицензий на использование и поддержку. Особенно дорогие решения для крупных объемов данных.
Что-то ещё: Бесплатные решения, такие как Fluentd или Loki, могут быть более доступными по цене, но потребуют дополнительных усилий для интеграции.

Управление и поддержка:

ELK Stack: Хорошая поддержка через сообщество, но наличие коммерческой поддержки позволяет повысить надежность решения. Может потребовать больших усилий для настройки.
OpenSearch: Сообщество активно поддерживает OpenSearch, есть возможность коммерческой поддержки, но уровень ее может быть ниже, чем у крупных компаний.
Splunk: Обладает отличной поддержкой и готовыми решениями, но поддержка стоит дорого, что может быть препятствием для небольших компаний.
Что-то ещё: Могут быть менее мощные системы для логирования, которые будут дешевле, но потребуют дополнительных усилий по интеграции и настройке.

Вывод

Для большинства современных систем логирования, если требуется комбинация хорошей производительности, гибкости и экономичности, OpenSearch или ELK Stack (в зависимости от конкретных потребностей по лицензированию и масштабированию) будут оптимальными решениями. Splunk подойдет для крупных предприятий с высокими требованиями к поддержке и готовым решением, но это решение требует значительных инвестиций.
